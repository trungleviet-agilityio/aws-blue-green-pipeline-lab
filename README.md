## AWS Blue/Green Pipeline Lab

A minimal Node.js app and CI/CD configuration you can use to practice blue/green deployments on AWS. The app is deployed to AWS Elastic Beanstalk through AWS CodePipeline and AWS CodeBuild.

### What’s included
- **Application**: Simple Node.js HTTP server on port 80 (`app.js`).
- **Elastic Beanstalk (Single Container Docker)**: `Dockerrun.aws.json` pins the container image to `node:20` and exposes port `80`.
- **Build**: `buildspec.yml` installs Node.js 20 and runs npm commands in CodeBuild.
- **(Optional) CodeDeploy Hooks**: `appspec.yml` with lifecycle scripts under `scripts/` for EC2/CodeDeploy style flows. You won’t need these when deploying to Elastic Beanstalk, but they are handy for comparative labs.

### Repository structure
```
app.js                      # Node.js app (Hello, AWS CodePipeline!)
package.json                # NPM metadata (main: app.js)
buildspec.yml               # CodeBuild build instructions
Dockerrun.aws.json          # Elastic Beanstalk single-container Docker spec
appspec.yml                 # CodeDeploy lifecycle hooks (optional for EB)
scripts/
  install_dependencies.sh
  start_server.sh
  stop_server.sh
  validate_service.sh
```

---

## Local development
Requirements: Node.js 20+

```bash
npm install
npm start
# or: node app.js

curl -i http://localhost:80
```
Expected output body: `Hello, AWS CodePipeline!`

Note: If you don’t need a compile step, you can safely remove the `npm run build` command from `buildspec.yml` or add a build script in `package.json`:

```json
{
  "scripts": {
    "build": "echo 'Nothing to build'"
  }
}
```

---

## CI/CD with AWS CodePipeline → Elastic Beanstalk

### 1) Prerequisites
- An S3 artifact bucket for CodePipeline
- Elastic Beanstalk Application with two environments (recommended for blue/green), e.g. `sample-app-blue` and `sample-app-green`, Platform: Docker on EC2
- IAM roles:
  - `CodePipelineServiceRole` (or the autogenerated `AWSCodePipelineServiceRole-<region>-<pipeline>`)
  - CodeBuild service role with permission to read/write the artifact bucket
  - Elastic Beanstalk service role (autocreated as `aws-elasticbeanstalk-service-role`)

### 2) Create the pipeline
1. Source: GitHub (connect to this repository).
2. Build: CodeBuild project using `buildspec.yml`.
3. Deploy: Elastic Beanstalk provider.
   - Application: your EB Application name
   - Environment: the environment you want to update on each run (e.g., `sample-app-green`)
   - Action role: the pipeline’s action/service role (see Troubleshooting for required permissions)

### 3) Blue/Green workflow with Elastic Beanstalk
1. Maintain two EB environments under the same application, e.g., `blue` (live) and `green` (staging).
2. Point the pipeline’s Deploy action to the `green` environment.
3. On each commit, the pipeline deploys a new application version to `green`.
4. Verify health and run tests against `green`.
5. Swap environment URLs in Elastic Beanstalk: `green ↔ blue` (EB console: Environment actions → Swap environment URLs). Now `green` serves production traffic and `blue` becomes the staging target for the next release.

---

## Troubleshooting

### Deploy action failed: missing CreateApplicationVersion
If the Deploy stage fails with a message similar to:

> The provided role does not have the elasticbeanstalk:CreateApplicationVersion permission

Grant the pipeline’s Deploy action role the necessary permissions. Attach a managed policy (quick) or add an inline least‑privilege policy.

Minimal inline policy example (adjust ARNs for your account and artifact bucket):

```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Sid": "EBDeploy",
      "Effect": "Allow",
      "Action": [
        "elasticbeanstalk:CreateApplicationVersion",
        "elasticbeanstalk:UpdateEnvironment",
        "elasticbeanstalk:Describe*",
        "elasticbeanstalk:List*"
      ],
      "Resource": "*"
    },
    {
      "Sid": "ReadArtifacts",
      "Effect": "Allow",
      "Action": [
        "s3:GetObject",
        "s3:GetObjectVersion",
        "s3:GetBucketVersioning",
        "s3:ListBucket"
      ],
      "Resource": [
        "arn:aws:s3:::<artifact-bucket>",
        "arn:aws:s3:::<artifact-bucket>/*"
      ]
    },
    {
      "Sid": "PassEBServiceRoleIfUsed",
      "Effect": "Allow",
      "Action": "iam:PassRole",
      "Resource": "arn:aws:iam::<account-id>:role/aws-elasticbeanstalk-service-role",
      "Condition": { "StringEquals": { "iam:PassedToService": "elasticbeanstalk.amazonaws.com" } }
    }
  ]
}
```

If your artifact bucket uses a KMS key, also grant the action role `kms:Decrypt` on that key.

### Health check / port issues
- The app listens on port `80`. Ensure the EB environment’s container port mapping allows traffic to port `80` and your security group permits HTTP.
- `scripts/validate_service.sh` uses `curl -f http://localhost:80` to verify a healthy deployment.

---

## Notes
- `appspec.yml` and the `scripts/` folder are used by CodeDeploy/EC2 style deployments. Elastic Beanstalk deployments rely on `Dockerrun.aws.json`. You can keep both in the repo for learning purposes.
- For very simple apps, add a no‑op build step as shown above or remove the `npm run build` line from `buildspec.yml`.

---

## Cleanup
- Delete the CodePipeline pipeline and CodeBuild project.
- Terminate Elastic Beanstalk environments and the application to stop charges.
- Remove the S3 artifact bucket if it’s not used elsewhere.

---

## License
This project is provided for educational purposes. Use at your own risk.


